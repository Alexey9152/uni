<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—è</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { font-size: 24px; }
        header a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
            font-weight: 600;
        }
        header a:hover { text-decoration: underline; }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #ddd;
        }
        .nav-tabs button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .nav-tabs button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .nav-tabs button:hover { color: #667eea; }
        .tab-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .tab-content.active { display: block; }
        h2 { margin-bottom: 20px; color: #333; }
        h3 { margin-top: 30px; margin-bottom: 15px; color: #555; }
        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        label { font-weight: 600; margin-bottom: 5px; }
        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th { background: #f0f0f0; padding: 12px; text-align: left; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #message { display: none; }
        #error { display: none; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            max-width: 800px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .btn-secondary {
            background: #999;
        }
        .btn-secondary:hover {
            background: #777;
        }
        #noBooksMessage {
            text-align: center;
            padding: 20px;
            color: #999;
            display: none;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-pending { background: #ffc107; color: #000; }
        .badge-processing { background: #17a2b8; color: #fff; }
        .badge-completed { background: #28a745; color: #fff; }
        .badge-rejected { background: #dc3545; color: #fff; }
    </style>
</head>
<body>
<header>
    <h1>üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ - –ü–∞–Ω–µ–ª—å –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—è</h1>
    <div>
        <span th:text="'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + ${username}"></span>
        <a href="/logout">–í—ã—Ö–æ–¥</a>
    </div>
</header>

<div class="container">
    <div id="message" class="alert alert-success"></div>
    <div id="error" class="alert alert-error"></div>

    <div class="nav-tabs">
        <button class="nav-btn active" data-tab="books">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥–∞–º–∏</button>
        <button class="nav-btn" data-tab="add">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</button>
        <button class="nav-btn" data-tab="issue">–í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É</button>
        <button class="nav-btn" data-tab="orders">–ó–∞–∫–∞–∑—ã</button>
        <button class="nav-btn" data-tab="readers">–ß–∏—Ç–∞—Ç–µ–ª–∏</button>
    </div>

    <!-- –¢–∞–±: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥–∞–º–∏ -->
    <div id="books" class="tab-content active">
        <h2>–í—Å–µ –∫–Ω–∏–≥–∏ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ</h2>
        <table id="booksTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ê–≤—Ç–æ—Ä—ã</th>
                <th>–ì–æ–¥</th>
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th>–¶–µ–Ω–∞</th>
                <th>–í—Å–µ–≥–æ</th>
                <th>–í –Ω–∞–ª–∏—á–∏–∏</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- –¢–∞–±: –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É -->
    <div id="add" class="tab-content">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–Ω–∏–≥—É</h2>
        <form id="addBookForm">
            <div class="form-group">
                <label for="bookId">ID:</label>
                <input type="text" id="bookId" required>
            </div>
            <div class="form-group">
                <label for="bookTitle">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="bookTitle" required>
            </div>
            <div class="form-group">
                <label for="bookAuthors">–ê–≤—Ç–æ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                <input type="text" id="bookAuthors" required>
            </div>
            <div class="form-group">
                <label for="bookYear">–ì–æ–¥:</label>
                <input type="number" id="bookYear" required>
            </div>
            <div class="form-group">
                <label for="bookCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                <input type="text" id="bookCategory" required>
            </div>
            <div class="form-group">
                <label for="bookPrice">–¶–µ–Ω–∞:</label>
                <input type="number" id="bookPrice" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="bookTotal">–í—Å–µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤:</label>
                <input type="number" id="bookTotal" required>
            </div>
            <div class="form-group">
                <label for="bookAvailable">–í –Ω–∞–ª–∏—á–∏–∏:</label>
                <input type="number" id="bookAvailable" required>
            </div>
            <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</button>
        </form>
    </div>

    <!-- –¢–∞–±: –í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É -->
    <div id="issue" class="tab-content">
        <h2>–í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É —á–∏—Ç–∞—Ç–µ–ª—é</h2>
        <div class="form-group">
            <label for="bookIdIssue">–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É:</label>
            <select id="bookIdIssue"></select>
        </div>
        <div class="form-group">
            <label for="readerSelect">–í—ã–±–µ—Ä–∏—Ç–µ —á–∏—Ç–∞—Ç–µ–ª—è:</label>
            <select id="readerSelect">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —á–∏—Ç–∞—Ç–µ–ª—è --</option>
            </select>
        </div>
        <button class="btn" onclick="issueBook()">–í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É</button>
    </div>

    <!-- –¢–∞–±: –ó–∞–∫–∞–∑—ã -->
    <div id="orders" class="tab-content">
        <h2>–ó–∞–∫–∞–∑—ã –æ—Ç —á–∏—Ç–∞—Ç–µ–ª–µ–π</h2>

        <h3>–û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã</h3>
        <table id="pendingOrdersTable">
            <thead>
            <tr>
                <th>ID –∑–∞–∫–∞–∑–∞</th>
                <th>–ß–∏—Ç–∞—Ç–µ–ª—å</th>
                <th>–ö–Ω–∏–≥–∞</th>
                <th>–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>–í—Å–µ –∑–∞–∫–∞–∑—ã</h3>
        <table id="allOrdersTable">
            <thead>
            <tr>
                <th>ID –∑–∞–∫–∞–∑–∞</th>
                <th>–ß–∏—Ç–∞—Ç–µ–ª—å</th>
                <th>–ö–Ω–∏–≥–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                <th>–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- –¢–∞–±: –ß–∏—Ç–∞—Ç–µ–ª–∏ -->
    <div id="readers" class="tab-content">
        <h2>–°–ø–∏—Å–æ–∫ —á–∏—Ç–∞—Ç–µ–ª–µ–π</h2>
        <table id="readersTable">
            <thead>
            <tr>
                <th>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                <th>–ü–æ–ª–Ω–æ–µ –∏–º—è</th>
                <th>–í—ã–¥–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–Ω–∏–≥ —á–∏—Ç–∞—Ç–µ–ª—è -->
<div id="readerBooksModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalReaderName"></h2>
            <button class="btn btn-secondary" onclick="closeReaderBooksModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <table id="readerBooksTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ê–≤—Ç–æ—Ä</th>
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="noBooksMessage">
            –£ —á–∏—Ç–∞—Ç–µ–ª—è –Ω–µ—Ç –≤—ã–¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥
        </div>
    </div>
</div>

<script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');

            if (this.dataset.tab === 'books') {
                loadBooks();
            }
            if (this.dataset.tab === 'issue') {
                loadBooksForIssue();
                loadReadersForIssue();
            }
            if (this.dataset.tab === 'orders') {
                loadPendingOrders();
                loadAllOrders();
            }
            if (this.dataset.tab === 'readers') {
                loadReaders();
            }
        });
    });

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥–∏
    function loadBooks() {
        fetch('/api/librarian/books', { credentials: 'include' })
            .then(r => r.json())
            .then(books => {
                const tbody = document.querySelector('#booksTable tbody');
                tbody.innerHTML = '';
                books.forEach(book => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${book.id}</td>
                        <td>${book.title}</td>
                        <td>${book.authors}</td>
                        <td>${book.year}</td>
                        <td>${book.category}</td>
                        <td>${book.price.toFixed(2)}</td>
                        <td>${book.total}</td>
                        <td>${book.available}</td>
                        <td>
                            <button class="btn" onclick="editPrice('${book.id}')" style="margin-bottom: 5px;">–ü–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞</button>
                            <button class="btn" onclick="editQuantity('${book.id}', ${book.total}, ${book.available})">–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</button>
                        </td>
                    `;
                });
            })
            .catch(err => showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥'));
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥–∏ –¥–ª—è –≤—ã–¥–∞—á–∏
    function loadBooksForIssue() {
        fetch('/api/librarian/books', { credentials: 'include' })
            .then(r => r.json())
            .then(books => {
                const select = document.getElementById('bookIdIssue');
                select.innerHTML = '';
                books.filter(b => b.available > 0).forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.id;
                    option.textContent = `${book.title} (${book.available}/${book.total})`;
                    select.appendChild(option);
                });
            })
            .catch(err => showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥ –¥–ª—è –≤—ã–¥–∞—á–∏'));
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∏—Ç–∞—Ç–µ–ª–µ–π –≤ select
    function loadReadersForIssue() {
        fetch('/api/librarian/readers', { credentials: 'include' })
            .then(r => r.json())
            .then(readers => {
                const select = document.getElementById('readerSelect');
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —á–∏—Ç–∞—Ç–µ–ª—è --</option>';
                readers.forEach(reader => {
                    const option = document.createElement('option');
                    option.value = reader.username;
                    option.textContent = `${reader.fullName} (${reader.username})`;
                    select.appendChild(option);
                });
            })
            .catch(err => showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∏—Ç–∞—Ç–µ–ª–µ–π'));
    }

    // –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É
    document.getElementById('addBookForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const id = document.getElementById('bookId').value.trim();
        const title = document.getElementById('bookTitle').value.trim();
        const authors = document.getElementById('bookAuthors').value.trim();
        const year = parseInt(document.getElementById('bookYear').value);
        const category = document.getElementById('bookCategory').value.trim();
        const price = parseFloat(document.getElementById('bookPrice').value);
        const total = parseInt(document.getElementById('bookTotal').value);
        const available = parseInt(document.getElementById('bookAvailable').value);

        // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if (!id || !title || !authors || !category) {
            showError('–í—Å–µ –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã');
            return;
        }

        if (!/^[a-zA-Z0-9_-]+$/.test(id)) {
            showError('ID –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ');
            return;
        }

        if (year < 0 || year > 2100) {
            showError('–ì–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 2100');
            return;
        }

        if (price < 0 || price > 1000000) {
            showError('–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 1 000 000');
            return;
        }

        if (total < 0 || total > 10000) {
            showError('–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 0 –¥–æ 10 000');
            return;
        }

        if (available < 0 || available > total) {
            showError('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –Ω–∞–ª–∏—á–∏–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 0 –¥–æ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞');
            return;
        }

        const book = {
            id: id,
            title: title,
            authors: authors,
            year: year,
            category: category,
            price: price,
            total: total,
            available: available
        };

        fetch('/api/librarian/books', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(book),
            credentials: 'include'
        })
        .then(r => r.text())
        .then(msg => {
            if (msg.includes('—É—Å–ø–µ—à–Ω–æ')) {
                showMessage(msg);
                this.reset();
                loadBooks();
            } else {
                showError(msg);
            }
        })
        .catch(err => showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–Ω–∏–≥–∏'));
    });

    // –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É
    function editPrice(bookId) {
        const newPrice = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É:');
        if (newPrice === null || newPrice === '') return;

        const price = parseFloat(newPrice);

        if (isNaN(price)) {
            showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ');
            return;
        }

        if (price < 0) {
            showError('–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π');
            return;
        }

        if (price > 1000000) {
            showError('–¶–µ–Ω–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è (–º–∞–∫—Å–∏–º—É–º 1 000 000)');
            return;
        }

        fetch(`/api/librarian/books/${bookId}/price?price=${price}`, {
            method: 'PUT',
            credentials: 'include'
        })
        .then(r => r.text())
        .then(msg => {
            showMessage(msg);
            loadBooks();
        })
        .catch(err => showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã'));
    }

    // –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥
    function editQuantity(bookId, currentTotal, currentAvailable) {
        const newTotal = prompt(`–í–≤–µ–¥–∏—Ç–µ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ (—Ç–µ–∫—É—â–µ–µ: ${currentTotal}):`);
        if (newTotal === null || newTotal === '') return;

        const newAvailable = prompt(`–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –Ω–∞–ª–∏—á–∏–∏ (—Ç–µ–∫—É—â–µ–µ: ${currentAvailable}):`);
        if (newAvailable === null || newAvailable === '') return;

        const total = parseInt(newTotal);
        const available = parseInt(newAvailable);

        if (isNaN(total) || isNaN(available)) {
            showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —á–∏—Å–ª–∞');
            return;
        }

        if (total < 0 || available < 0) {
            showError('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º');
            return;
        }

        if (available > total) {
            showError('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –Ω–∞–ª–∏—á–∏–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞');
            return;
        }

        if (total > 10000) {
            showError('–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–º–∞–∫—Å–∏–º—É–º 10 000)');
            return;
        }

        fetch(`/api/librarian/books/${bookId}/quantity?total=${total}&available=${available}`, {
            method: 'PUT',
            credentials: 'include'
        })
        .then(r => r.text())
        .then(msg => {
            showMessage(msg);
            loadBooks();
        })
        .catch(err => showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞'));
    }

    // –í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É
    function issueBook() {
        const bookId = document.getElementById('bookIdIssue').value;
        const readerUsername = document.getElementById('readerSelect').value;

        if (!bookId || !readerUsername) {
            showError('–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É –∏ —á–∏—Ç–∞—Ç–µ–ª—è');
            return;
        }

        fetch(`/api/librarian/books/${bookId}/issue?readerUsername=${readerUsername}`, {
            method: 'POST',
            credentials: 'include'
        })
        .then(r => r.text())
        .then(msg => {
            showMessage(msg);
            document.getElementById('readerSelect').value = '';
            loadBooksForIssue();
            loadReadersForIssue();
        })
        .catch(err => showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ –∫–Ω–∏–≥–∏'));
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã
    function loadPendingOrders() {
        fetch('/api/librarian/orders/pending', { credentials: 'include' })
            .then(r => r.json())
            .then(orders => {
                const tbody = document.querySelector('#pendingOrdersTable tbody');
                tbody.innerHTML = '';

                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤</td></tr>';
                    return;
                }

                orders.forEach(order => {
                    const row = tbody.insertRow();
                    const createdAt = new Date(order.createdAt).toLocaleString('ru-RU');
                    row.innerHTML = `
                        <td>${order.orderId.substring(0, 8)}...</td>
                        <td>${order.userFullName} (${order.username})</td>
                        <td>${order.bookTitle}</td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn" onclick="approveOrder('${order.orderId}')" style="margin-right: 5px;">
                                –û–¥–æ–±—Ä–∏—Ç—å
                            </button>
                            <button class="btn btn-danger" onclick="rejectOrder('${order.orderId}')">
                                –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        </td>
                    `;
                });
            })
            .catch(err => showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤'));
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã
    function loadAllOrders() {
        fetch('/api/librarian/orders', { credentials: 'include' })
            .then(r => r.json())
            .then(orders => {
                const tbody = document.querySelector('#allOrdersTable tbody');
                tbody.innerHTML = '';

                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</td></tr>';
                    return;
                }

                orders.forEach(order => {
                    const row = tbody.insertRow();
                    const createdAt = new Date(order.createdAt).toLocaleString('ru-RU');
                    let badgeClass = 'badge-pending';
                    switch(order.status) {
                        case 'PENDING': badgeClass = 'badge-pending'; break;
                        case 'PROCESSING': badgeClass = 'badge-processing'; break;
                        case 'COMPLETED': badgeClass = 'badge-completed'; break;
                        case 'REJECTED': badgeClass = 'badge-rejected'; break;
                    }
                    row.innerHTML = `
                        <td>${order.orderId.substring(0, 8)}...</td>
                        <td>${order.userFullName}</td>
                        <td>${order.bookTitle}</td>
                        <td><span class="badge ${badgeClass}">${order.status}</span></td>
                        <td>${order.message}</td>
                        <td>${createdAt}</td>
                    `;
                });
            })
            .catch(err => showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤'));
    }

    // –û–¥–æ–±—Ä–∏—Ç—å –∑–∞–∫–∞–∑
    function approveOrder(orderId) {
        if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
            return;
        }

        fetch(`/api/librarian/orders/${orderId}/approve`, {
            method: 'POST',
            credentials: 'include'
        })
        .then(r => r.text())
        .then(msg => {
            showMessage(msg);
            loadPendingOrders();
            setTimeout(() => loadAllOrders(), 500);
        })
        .catch(err => showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞'));
    }

    // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
    function rejectOrder(orderId) {
        const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):');
        if (reason === null) {
            return;
        }

        let url = `/api/librarian/orders/${orderId}/reject`;
        if (reason) {
            url += `?reason=${encodeURIComponent(reason)}`;
        }

        fetch(url, {
            method: 'POST',
            credentials: 'include'
        })
        .then(r => r.text())
        .then(msg => {
            showMessage(msg);
            loadPendingOrders();
            loadAllOrders();
        })
        .catch(err => showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞'));
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–∏—Ç–∞—Ç–µ–ª–µ–π
    function loadReaders() {
        fetch('/api/librarian/readers', { credentials: 'include' })
            .then(r => r.json())
            .then(readers => {
                const tbody = document.querySelector('#readersTable tbody');
                tbody.innerHTML = '';
                readers.forEach(reader => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${reader.username}</td>
                        <td>${reader.fullName}</td>
                        <td>${reader.borrowedBookIds.length} –∫–Ω–∏–≥</td>
                        <td>
                            <button class="btn" onclick="showReaderBooks('${reader.username}', '${reader.fullName}')">
                                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–Ω–∏–≥–∏
                            </button>
                        </td>
                    `;
                });
            })
            .catch(err => showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∏—Ç–∞—Ç–µ–ª–µ–π'));
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–∏–≥–∏ —á–∏—Ç–∞—Ç–µ–ª—è
    function showReaderBooks(username, fullName) {
        document.getElementById('modalReaderName').textContent = `–ö–Ω–∏–≥–∏ —á–∏—Ç–∞—Ç–µ–ª—è: ${fullName}`;
        document.getElementById('readerBooksModal').style.display = 'block';

        fetch(`/api/librarian/readers/${username}`, { credentials: 'include' })
            .then(r => r.json())
            .then(reader => {
                const tbody = document.querySelector('#readerBooksTable tbody');
                tbody.innerHTML = '';

                if (reader.borrowedBookIds.length === 0) {
                    document.getElementById('noBooksMessage').style.display = 'block';
                    document.getElementById('readerBooksTable').style.display = 'none';
                    return;
                }

                document.getElementById('noBooksMessage').style.display = 'none';
                document.getElementById('readerBooksTable').style.display = 'table';

                const bookPromises = reader.borrowedBookIds.map(bookId =>
                    fetch('/api/librarian/books', { credentials: 'include' })
                        .then(r => r.json())
                        .then(books => books.find(b => b.id === bookId))
                );

                Promise.all(bookPromises).then(books => {
                    books.forEach(book => {
                        if (book) {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${book.id}</td>
                                <td>${book.title}</td>
                                <td>${book.authors}</td>
                                <td>${book.category}</td>
                                <td>
                                    <button class="btn" onclick="returnBookFromReader('${book.id}', '${username}', '${fullName}')">
                                        –í–µ—Ä–Ω—É—Ç—å
                                    </button>
                                </td>
                            `;
                        }
                    });
                });
            })
            .catch(err => showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥ —á–∏—Ç–∞—Ç–µ–ª—è'));
    }

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    function closeReaderBooksModal() {
        document.getElementById('readerBooksModal').style.display = 'none';
    }

    // –í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É –æ—Ç —á–∏—Ç–∞—Ç–µ–ª—è
    function returnBookFromReader(bookId, username, fullName) {
        if (!confirm(`–í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É –æ—Ç —á–∏—Ç–∞—Ç–µ–ª—è ${fullName}?`)) {
            return;
        }

        fetch(`/api/librarian/books/${bookId}/return?readerUsername=${username}`, {
            method: 'POST',
            credentials: 'include'
        })
        .then(r => r.text())
        .then(msg => {
            showMessage(msg);
            showReaderBooks(username, fullName);
            loadReaders();
            loadBooks();
        })
        .catch(err => showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫–Ω–∏–≥–∏'));
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
    document.getElementById('readerBooksModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReaderBooksModal();
        }
    });

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
    function showMessage(msg) {
        const el = document.getElementById('message');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    function showError(msg) {
        const el = document.getElementById('error');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadBooks();
</script>
</body>
</html>
